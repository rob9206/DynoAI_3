{
  "snapshot_metadata": {
    "generated_at": "2025-12-13T15:03:09Z",
    "repository": "rob9206/DynoAI_3",
    "purpose": "Complete engineering-accurate snapshot of DynoAI3 system",
    "schema_version": "1.0.0"
  },
  "modules": {
    "core_tuning": {
      "ai_tuner_toolkit_dyno_v1_2.py": {
        "loc": 2171,
        "role": "Main CLI entry point for dyno log analysis and VE correction generation",
        "key_functions": [
          "main() - CLI orchestration",
          "load_winpep_csv() - WinPEP log parser",
          "load_generic_csv() - PowerVision/generic parser",
          "detect_csv_format() - Auto-detect log format",
          "dyno_bin_aggregate() - Bin AFR error by RPM×MAP",
          "kernel_smooth() - K1 gradient-limited smoothing",
          "combine_front_rear() - Merge front/rear cylinders",
          "spark_suggestion() - Generate timing adjustments",
          "anomaly_diagnostics() - Outlier detection"
        ],
        "determinism": "Pure functions, no randomness, same input → same output"
      },
      "ve_operations.py": {
        "loc": 731,
        "role": "Safe VE table apply/rollback with audit trail",
        "key_classes": [
          "VEApply - Apply corrections with ±7% clamp",
          "VERollback - Reverse corrections with hash verification",
          "DualCylinderVEApply - Atomic-like dual cylinder operations"
        ],
        "key_functions": [
          "read_ve_table() - Parse VE CSV",
          "write_ve_table() - Write VE with 4-decimal precision",
          "clamp_factor_grid() - Safety clamping",
          "compute_sha256() - File integrity hashing"
        ],
        "symmetry": "Apply ↔ Rollback mathematically inverse"
      },
      "io_contracts.py": {
        "loc": 594,
        "role": "I/O validation, manifest system, path security",
        "key_functions": [
          "safe_path() - Prevent directory traversal",
          "make_run_id() - Generate unique run IDs",
          "file_sha256() - Compute file hashes",
          "sanitize_csv_cell() - Prevent Excel formula injection",
          "create_manifest() - Initialize run metadata",
          "add_output_entry() - Register output files",
          "finish_manifest() - Finalize with timing/status",
          "write_manifest_pair() - Write JSON + README"
        ],
        "security": "All I/O via safe_path(), SHA-256 integrity verification"
      },
      "dynoai/constants.py": {
        "loc": 268,
        "role": "Single source of truth for bin definitions and grid dimensions",
        "constants": {
          "RPM_BINS": "[1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000, 5500, 6000, 6500]",
          "KPA_BINS": "[35, 50, 65, 80, 95]",
          "GRID_CELLS": 55,
          "STOICH_AFR_GASOLINE": 14.57,
          "TORQUE_HP_CONVERSION": 5252.0,
          "AFR_RANGE_MIN": 9.0,
          "AFR_RANGE_MAX": 18.0,
          "HOT_IAT_THRESHOLD_F": 120.0
        }
      }
    },
    "api_services": {
      "autotune_workflow.py": {
        "loc": 854,
        "role": "Unified analysis engine for all data sources (CSV, JetDrive, PowerVision)"
      },
      "agent_orchestrator.py": {
        "loc": 626,
        "role": "AI agent task delegation (Reorg, BugFix, Guardian, PowerCore)",
        "agents": [
          "Reorg Agent - Infrastructure, CI/CD, docs",
          "BugFix Agent - Import errors, CSV robustness",
          "Guardian Agent - Math review (read-only)",
          "PowerCore Agent - Log parsing, PVV generation"
        ],
        "boundaries": "Each agent has explicit 'forbidden' list preventing tuning math changes"
      },
      "jetdrive_client.py": {
        "loc": 505,
        "role": "KLHDV multicast protocol for Dynojet JetDrive integration"
      },
      "powercore_integration.py": {
        "loc": 609,
        "role": "PVV XML generation for Power Vision tuner"
      }
    },
    "advanced_features": {
      "decel_management.py": {
        "loc": 745,
        "role": "Deceleration fuel cut recommendations (popping elimination)"
      },
      "cylinder_balancing.py": {
        "loc": 579,
        "role": "Per-cylinder AFR equalization for V-twins"
      },
      "heat_management.py": {
        "loc": 316,
        "role": "Thermal management and hot IAT compensation"
      },
      "knock_optimization.py": {
        "loc": 221,
        "role": "Spark timing optimization based on knock detection"
      }
    },
    "tests": {
      "location": "tests/",
      "coverage": [
        "test_autotune_workflow.py - End-to-end workflow",
        "test_agent_orchestrator.py - Agent delegation",
        "test_cylinder_balancing.py - Per-cylinder logic",
        "test_decel_management.py - Decel fuel cut",
        "test_bin_alignment.py - RPM/MAP binning",
        "test_preflight_csv.py - CSV validation",
        "test_delta_floor.py - Delta clamping",
        "test_fingerprint.py - Determinism verification"
      ],
      "strategy": "Unit tests for math, integration tests for workflows, determinism tests"
    }
  },
  "entry_points": {
    "cli": {
      "main_tuner": "python ai_tuner_toolkit_dyno_v1_2.py --csv data.csv --outdir ./results",
      "ve_apply": "python ve_operations.py apply --base base_ve.csv --factor correction.csv --output updated_ve.csv",
      "ve_rollback": "python ve_operations.py rollback --current updated_ve.csv --metadata updated_ve_meta.json --output restored_ve.csv",
      "selftest": "python selftest_runner.py"
    },
    "api": {
      "flask_app": "api/app.py",
      "analyze_endpoint": "POST /api/analyze",
      "jetdrive_endpoint": "POST /api/jetdrive/analyze",
      "xai_chat": "POST /api/xai/chat"
    },
    "headless": {
      "batch_processing": "Fully supported, unique run_id per run",
      "ci_integration": "GitHub Actions workflows in .github/workflows/",
      "docker": "Dockerfile + docker-compose.yml available"
    }
  },
  "artifacts": {
    "output_structure": {
      "runs": "runs/{run_id}/ - Preview outputs (CSV, TXT, JSON)",
      "ve_runs": "ve_runs/{run_id}/ - Apply outputs (updated VE + metadata)",
      "experiments": "experiments/ - Regression baselines (K1 kernel validation)"
    },
    "primary_outputs": [
      "VE_Correction_Delta_DYNO.csv - Primary VE delta grid (±12% clamped)",
      "VE_Delta_PasteReady.txt - Tab-delimited for tuner software",
      "AFR_Error_Map_Front.csv - Front cylinder AFR error",
      "AFR_Error_Map_Rear.csv - Rear cylinder AFR error",
      "Spark_Adjust_Suggestion_Front.csv - Front spark timing",
      "Spark_Adjust_Suggestion_Rear.csv - Rear spark timing (with rear rule)",
      "Coverage_Front.csv - Sample count per bin",
      "Coverage_Rear.csv - Sample count per bin",
      "Torque_Map_Combined.csv - Average torque by zone",
      "HP_Map_Combined.csv - Average HP by zone",
      "Diagnostics_Report.txt - Text summary",
      "Anomaly_Hypotheses.json - Outlier detection",
      "manifest.json - Full run metadata with SHA-256 hashes"
    ],
    "optional_outputs": [
      "VE_Front_Updated.csv - Absolute VE table (if --base-front provided)",
      "Decel_Fuel_Overlay.csv - Decel fuel cut (if --decel-management)",
      "Front_Balance_Factor.csv - Cylinder balance (if --balance-cylinders)"
    ]
  },
  "invariants": {
    "grid_dimensions": {
      "rpm_bins": 11,
      "kpa_bins": 5,
      "total_cells": 55,
      "rpm_range": "1500-6500 RPM (500 RPM steps)",
      "kpa_range": "35-95 kPa (15 kPa steps)",
      "breaking_change": "Changing bin count or values"
    },
    "determinism": {
      "guarantee": "Same CSV + same args → same output (bit-for-bit)",
      "no_randomness": "No random seeds, no adaptive learning, no cross-run state",
      "exception": "Run ID generation uses os.urandom() (not in math)"
    },
    "clamping": {
      "preview_mode": "±12% (default, configurable via --clamp)",
      "apply_mode": "±7% (hardcoded in VEApply)",
      "multiplier_bounds": "[0.93, 1.07] for ±7% clamp",
      "rationale": "Safety first, prevents dangerous VE changes"
    },
    "afr_error_convention": {
      "formula": "(afr_cmd - afr_meas) / afr_meas × 100",
      "negative": "Running RICH (too much fuel, decrease VE)",
      "positive": "Running LEAN (not enough fuel, increase VE)"
    },
    "binning_algorithm": "Nearest neighbor (minimum absolute difference)",
    "aggregation": "Torque or HP weighted average (weight ≥ 5 ft-lb threshold)",
    "k1_kernel": {
      "stages": [
        "1. Gradient calculation (max neighbor diff)",
        "2. Adaptive smoothing (0-N passes based on magnitude)",
        "3. Gradient-limited blending (high gradient → preserve original)",
        "4. Coverage-weighted smoothing (α=0.20, center_bias=1.25)"
      ],
      "thresholds": {
        "large_correction": "≥3.0% (0 passes)",
        "small_correction": "≤1.0% (full passes)",
        "taper_range": "1-3% (linear interpolation)"
      }
    },
    "rollback_symmetry": "Apply ↔ Rollback mathematically inverse (within floating-point precision)",
    "rear_safety_zone": {
      "rpm_range": "2800-3600 RPM",
      "kpa_range": "75-95 kPa",
      "base_retard": "-2.0° (configurable)",
      "hot_iat_extra": "-1.0° if IAT ≥ 120°F"
    },
    "manifest_completeness": "Every run produces manifest with SHA-256 hashes for all inputs/outputs",
    "safe_path_requirement": "All file I/O via io_contracts.safe_path() (directory traversal prevention)",
    "preview_before_apply": "Default is preview mode (CSV only), apply requires explicit action"
  },
  "contracts": {
    "csv_input_formats": {
      "winpep": {
        "delimiters": ["tab", "comma"],
        "encoding": ["utf-8-sig", "cp1252"],
        "required_columns": ["rpm", "map/kpa", "torque"],
        "optional_columns": ["afr_cmd_f/r", "afr_meas_f/r", "knock_f/r", "iat", "tps", "vbatt", "hp"]
      },
      "powervision": {
        "markers": ["(PV) Engine Speed", "(DWR CPU) Torque", "(PV) WBO2 AFR Front"],
        "lambda_conversion": "afr = lambda × 14.57",
        "torque_derivation": "torque = (hp × 5252) / rpm"
      },
      "generic": {
        "flexible_matching": "Case-insensitive substring matching",
        "same_fallbacks": "Lambda→AFR, HP→Torque"
      }
    },
    "csv_output_format": {
      "header": "RPM, kpa1, kpa2, ...",
      "value_format": "{:+.2f} for deltas (signed, 2 decimals)",
      "ve_precision": "{:.4f} for absolute VE (4 decimals)",
      "sanitization": "Prepend ' to numeric cells (Excel safety)"
    },
    "units": {
      "rpm": "revolutions/minute (400-8000)",
      "kpa": "kilopascals (10-110)",
      "torque": "foot-pounds (>5 threshold)",
      "afr": "ratio (9.0-18.0, stoich=14.57)",
      "lambda": "ratio (0.6-1.3)",
      "iat": "°F (30-300)",
      "spark": "degrees (-2.0 to 0.0, retard only)"
    },
    "manifest_schema": {
      "schema_id": "dynoai.manifest@1",
      "required_fields": ["run_id", "input", "timing", "outputs", "ok", "last_stage", "stats"],
      "sha256_required": "All inputs and outputs"
    }
  },
  "ai_boundaries": {
    "invocation_points": [
      "XAI/Grok chat endpoint (POST /api/xai/chat) - Conversational advice",
      "Agent Orchestrator (api/services/agent_orchestrator.py) - Task delegation",
      "Training Data Collector (api/services/training_data_collector.py) - Data collection only"
    ],
    "what_ai_sees": [
      "XAI: User-provided context (questions, reports)",
      "Orchestrator: Task descriptions, file paths",
      "Collector: Run manifests, AFR grids (read-only)"
    ],
    "what_ai_outputs": [
      "XAI: Text responses (explanations, suggestions)",
      "Orchestrator: Task assignments (no direct edits)",
      "Collector: Offline analysis data (no real-time influence)"
    ],
    "hard_boundaries": {
      "forbidden_lists": "Each agent has explicit forbidden: [tuning_math, ve_operations, kernel_behavior, ...]",
      "code_isolation": "Tuning math in ai_tuner_toolkit_dyno_v1_2.py and ve_operations.py",
      "guardian_agent": "Reviews changes, cannot edit code",
      "no_model_deployment": "No trained ML models in production pipeline"
    },
    "advisory_only": "AI suggestions remain advisory, user must manually review and apply",
    "explainability": "All tuning math deterministic, inspectable, manifest includes full provenance"
  },
  "risks": {
    "identified": [],
    "note": "No risks identified. All contracts well-defined, determinism guaranteed, AI boundaries enforced."
  },
  "automation": {
    "headless_capable": true,
    "batch_processing": "Supported via unique run_id per run, no user interaction required",
    "ci_integration": "GitHub Actions, pytest, selftest_runner.py",
    "docker_support": "Dockerfile, docker-compose.yml",
    "ui_dependencies": "None (frontend is optional visualization layer)"
  },
  "limits_and_non_goals": {
    "does_not_do": [
      "Dyno control (delegated to WinPEP8, Dynojet software)",
      "Real-time tuning (offline analysis only)",
      "ECU flashing (delegated to Power Vision, TuneLab)",
      "Auto-apply tunes (human review required)",
      "Direct hardware interfacing (uses exported logs)",
      "Arbitrary ECU support (Harley-Davidson only)",
      "Closed-loop tuning (single-pass correction)",
      "Fuel pressure correction (assumes stable pressure)",
      "Ignition auto-apply (suggestions only)",
      "Multi-bike fleet management (per-run analysis)"
    ],
    "delegation": {
      "dyno_operation": "WinPEP8, Dynojet control software",
      "ecu_tuning": "Power Vision, TuneLab, dyno tuner",
      "hardware": "Dynojet systems, Power Core, LiveLink",
      "safety_validation": "Human operator, tuner expertise"
    },
    "scope": "AFR analysis + VE correction generation (advisory)"
  }
}
