================================================================================
DECELERATION RPM RUNAWAY FIX - SUMMARY
================================================================================

PROBLEM:
--------
Simulator randomly accelerated to 4500-5000 RPM at end of dyno runs instead
of smoothly decelerating back to idle.

ROOT CAUSE:
-----------
Throttle lag during PULL -> DECEL transition caused continued acceleration:
  1. Pull completes at 98% redline (5684 RPM for M8-114)
  2. State changes to DECEL, sets tps_target = 0
  3. But tps_actual still partially open due to throttle lag
  4. Physics engine continues generating torque
  5. RPM continues climbing before throttle fully closes

SOLUTION:
---------
Three key changes in api/services/dyno_simulator.py:

1. IMMEDIATE THROTTLE CLOSURE (Line 1222)
   - Force tps_actual = 0.0 when entering DECEL state
   - Bypasses throttle lag simulation for safety

2. RPM CLAMPING IN DECEL (Lines 1228-1231)
   - Clamp RPM between 80% idle and redline
   - Prevents overshoot in either direction

3. TRANSITION SAFETY (Lines 1207-1217)
   - Clamp RPM to redline when pull completes
   - Force immediate throttle closure at transition

RESULTS:
--------
BEFORE:
  - Random RPM spikes to 4500-5000+
  - Inconsistent behavior
  - Unrealistic deceleration

AFTER:
  - Max decel RPM: 5684 (properly clamped at redline)
  - Only 4.2% of decel time above 85% redline
  - Consistent across multiple pulls
  - Smooth, realistic deceleration

TEST VERIFICATION:
------------------
✓ All 25 physics simulator tests pass
✓ Multiple pull consistency test passes
✓ RPM properly clamped at redline
✓ No security issues (Snyk scan: 0 issues)

IMPACT:
-------
✓ Safety: Prevents RPM overshoot
✓ Realism: Accurate dyno behavior
✓ Consistency: Predictable results
✓ UX: Smooth transitions

FILES MODIFIED:
---------------
- api/services/dyno_simulator.py
  * _handle_decel_state() - Immediate throttle closure + RPM clamping
  * _handle_pull_state() - RPM clamping at pull completion

DOCUMENTATION:
--------------
- DECEL_RPM_RUNAWAY_FIX.md - Detailed technical documentation
- This file - Quick reference summary

================================================================================
STATUS: FIXED ✓
DATE: December 15, 2025
================================================================================

